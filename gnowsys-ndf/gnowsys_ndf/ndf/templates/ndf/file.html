{% extends "ndf/base.html" %}
{% load i18n %}
{% load ndf_tags %}
{% load pagination_tags %}
{% get_group_name groupid as group_name_tag %}

{% block title %} {{title}} {% endblock %}

<!-- left top panel -->
{% block meta_content %}
  <h2 class="subheader">{% trans "Gallery" %}</h2>
{% endblock %}


{% block help_content %}
  <h3>{% trans "Files" %}</h3>
  <p>
    {% trans "Upload your files from your computer to metaStudio. You can view the existing files in the group and create collections." %}
  </p>
{% endblock %}


{% block shelf_content %}
  {% if user.is_authenticated %}
    {% include "ndf/shelf.html" %}
  {% else %}
  <h4>Please Login to create your shelf</h4>
  {% endif %}  
{% endblock %}


<!-- actions -->
{% block app_action_list %}

  {% if user.is_authenticated %}
    {% user_access_policy groupid request.user as user_access %}
    {% if user_access == "allow" %}

      <li>
          <a href="{% url 'uploadDoc' group_name_tag %}?next={{request.path}}">
            {% trans "Upload File" %}
          </a>
      </li>
    
      <li>
        <a href="{% url 'data_review' group_name_tag %}">
          {% trans "Data Review" %}
        </a>
      </li>

    {% endif %}
  {% endif %}

  <li>
    <a href="#" data-reveal-id="library-statistics">
      {% trans "File Statistics" %}
    </a>
  </li>

  <div class="medium reveal-modal" id="library-statistics" data-reveal>
    {% include "ndf/file_statistics.html" %}
    <a class="close-reveal-modal">&#215;</a>
  </div>

{% endblock %}

{% block body_content %}
  {% get_group_name groupid as group_name_tag %}

<header class="row">
  <dl class="tabs" data-tab >
    
    <!-- all files -->
    <dd class="active">
      <a href="#view-all">
        <i class="fi-eye"></i>
        {% trans "All files" %} {% if file_pages.count > 0 %}({{ file_pages.count }}){% endif %}
      </a>
    </dd>
    
    <!-- Documents -->
    <dd>
      <a href="#view-doc">
        <i class="fi-page-filled"></i>
        {% trans "Documents" %} {% if doc_pages.count > 0 %}({{ doc_pages.count }}){% endif %}
      </a>
    </dd>

    <!-- Interactives -->
    {% if interactiveCollection.count %}
      <dd>
        <a href="#view-interactive">
          <i class="fi-arrows-compress"></i>
          {% trans "Interactives" %} ({{ interactiveCollection.count }})
        </a>
      </dd>
    {% endif %}

    <!-- Audio -->
    {% if audioCollection.count %}
      <dd>
        <a href="#view-audio">
          <i class="fi-music"></i>
          {% trans "Audios" %} ({{ audioCollection.count }})
        </a>
      </dd>
    {% endif %}

    <!-- Image -->
    <dd>
      <a href="#view-image"><i class="fi-camera"></i>
        {% trans "Images" %} {% if image_pages.count > 0 %}({{ image_pages.count }}){% endif %}
      </a>
    </dd>

    <!-- Video -->
    {% if site.SITE_VIDEO == 'pandora_and_local' or site.SITE_VIDEO == 'local' %}
      <dd>
        <a href="#view-video"><i class="fi-video"></i>
          {% trans "Videos" %} {% if video_pages.count > 0 %}({{ video_pages.count }}){% endif %}
        </a>
      </dd>
    {% endif %}

    <!-- Pandora -->
    {% if site.SITE_VIDEO == 'pandora_and_local' %}
      <dd>
        <a href="#view-pandora-video"><i class="fi-video"></i>
          {% trans "Pandora Videos" %}
        </a>
      </dd>
    {% endif %}

    {% if site.SITE_VIDEO == 'pandora' %}
      <dd>
        <a href="#view-pandora-video"><i class="fi-video"></i>
          {% trans "Videos" %}
          {% if pandoravideoCollection.count %}
            ({{ pandoravideoCollection.count }})
          {% endif %}
        </a>
      </dd>
    {% endif %}

    {% if title != "E-Library" %}
      <dd>
        <a href="#view-collection">
          <i class="fi-page-multiple"></i>{% trans "Collections" %}
        </a>
      </dd>
    {% endif %}

   </dl>
</header>

<div class="tabs-content gallery">

  {% if already_uploaded %} 
    <div id="message">
      <span style="color:red">
        {% trans "Files Listed below are already uploaded. Duplicate file uploads are not possible." %}
      </span>
      <ul>
        {% for each in already_uploaded %} 
          <li><b>"{{each}}"</b> {% trans "this file is already uploaded please choose different file" %} </li>
        {% endfor %}
      </ul>
    </div>
  {% endif %}

  {% group_type_info groupid request.user as grouptype %}

  <!-- Tab View #1 - All -->
  <div class="content row active" id="view-all">

    {% include "ndf/file_list_tab.html" with resource_type=files detail_urlname="file_detail" filetype="all" res_type_name="" page_info=file_pages %}

  </div>

  <!-- Tab View 2 - Documents -->
  <div class="content" id="view-doc">

    {% include "ndf/file_list_tab.html" with resource_type=docCollection detail_urlname="file_detail" filetype="doc" res_type_name="" page_info=doc_pages %}

  </div>


  <!-- Tab View 3 - Interactives -->
  {% if interactiveCollection %}
    <div class="content" id="view-interactive">

      {% include "ndf/file_list_tab.html" with resource_type=interactiveCollection detail_urlname="file_detail" filetype="interactives" res_type_name="" page_info=interactive_pages %}

    </div>
  {% endif %}


  <!-- Tab View 4 - Audios -->
  {% if audioCollection %}
    <div class="content" id="view-audio">

      {% include "ndf/file_list_tab.html" with resource_type=audioCollection detail_urlname="file_detail" filetype="audio" res_type_name="" page_info=audio_pages %}

    </div>
  {% endif %}

  <!-- Tab View #3 - Images -->
  <div class="content" id="view-image">

    {% include "ndf/file_list_tab.html" with resource_type=imageCollection detail_urlname="image_detail" filetype="image" res_type_name="" page_info=image_pages %}

  </div>

  <!-- Tab View #4 - Videos -->
  <div class="content" id="view-video">

    {% include "ndf/file_list_tab.html" with resource_type=videoCollection detail_urlname="video_detail" filetype="video" res_type_name="" page_info=video_pages %}

  </div>

  <!-- Tab View #5 - pandora Videos -->
  <div class="content" id="view-pandora-video">

    {% include "ndf/file_list_tab.html" with resource_type=pandoraCollection detail_urlname="video_detail" filetype="pandora-video" res_type_name="" page_info="" %}

  </div>
  
  <div class="content" id="view-collection">

    {% get_resource_collection groupid title as file_collections %}

    {% include "ndf/file_list_tab.html" with resource_type=file_collections detail_urlname="file_detail" filetype="collection" res_type_name="collection" %}

  </div>

</div>

{% endblock %}


<!-- Moved from videoDashboard -->

{% block script %}

  var eventhandler = function(e) { e.preventDefault();}

  $(document).on('click',".video",function(){
  //$('#body').css({opacity: "0.4"});
  $("#backcover").show();
  $('#body').bind('click', eventhandler);
  $('#pop_video').show();
  var video_id = this.id;
  var video_index = $('.video').index(this)
  var video_total = $('.video').length;
  var pre = $(".video_pre");
  var next = $(".video_next");
  var url = "/{{groupid}}/video/fullvideo/"+video_id
  $("#play_video").attr("src",url);
  $(".video_details_link").attr("href","/{{groupid}}/video/video_detail/"+video_id)
  if(video_index >= 1 && video_index < video_total-1)
  {
   pre.attr("id",video_index-1);
   next.attr("id",video_index+1);
 }
 else if(video_index == 0)
 {
  pre.hide();
  next.attr("id",video_index+1);
}
else if(video_index == video_total-1){
  pre.attr("id",video_index-1);
  next.hide();
}
else{
  pre.hide();
  next.hide();
}
});

  $(document).on('click',"#close",function(){
    $('#pop_video').hide();
    $("#backcover").hide();
    $("#play_video").attr("src","");
    $('#body').css({opacity: "1"});
    $('#body').unbind('click', eventhandler);
  });

  $(document).on('click',".video_pre",function(){
    var video_id = this.id;
    var video_index = parseInt(this.id);
    var video_total = $('.video').length;
    var pre = $(".video_pre");
    var next = $(".video_next");
    pre.show();
    next.show();
    var video_url = $(".video")[this.id].id
    var url = "/{{groupid}}/video/fullvideo/"+video_url
    $("#play_video").attr("src",url);
    $(".video_details_link").attr("href","/{{groupid}}/video/video_detail/"+video_url)
    if(video_index >= 1 && video_index < video_total-1)
    {
      pre.attr("id",video_index-1);
      next.attr("id",video_index + 1);
    }
    else if(video_index == 0)
    {
      pre.hide();
      next.attr("id",video_index+1);
    }
    else if(video_index == video_total-1){
      pre.attr("id",video_index-1);
      next.hide();
    }
    else{
      pre.hide();
      next.hide();
    }
  });

  $(document).on('click',".video_next",function(){
    var video_id = this.id;
    var video_index = parseInt(this.id);
    var video_total = $('.video').length;
    var pre = $(".video_pre");
    var next = $(".video_next");
    pre.show();
    next.show();
    var video_url = $(".video")[this.id].id
    var url = "/{{groupid}}/video/fullvideo/"+video_url
    $("#play_video").attr("src",url);
    $(".video_details_link").attr("href","/{{groupid}}/video/video_detail/"+video_url)
    if(video_index >= 1 && video_index < video_total-1)
    {
      pre.attr("id",video_index-1);
      next.attr("id",video_index+1);
    }
    else if(video_index == 0)
    {
      pre.hide();
      next.attr("id",video_index+1);
    }
    else if(video_index == video_total-1){
      pre.attr("id",video_index-1);
      next.hide();
    }
    else{
      pre.hide();
      next.hide();
    }
  });


  {% if is_video %}
    alert("Your video file uploaded succesfully, But still in process, play video about 1 hour after");
  {% endif %}


// <script type="text/javascript">

// pagination ajax  
$('ul.pagination a').click(function(e)
{
    e.preventDefault();
    populateFileList(this);    
});

function populateFileList(pageAnchor)
{

    var filetype = pageAnchor.href.split("/")[5],
        page_no = pageAnchor.text.trim(),
        no_of_objs_pp = 24,
        url = pageAnchor.href.substr(pageAnchor.href.search(pageAnchor.host)+pageAnchor.host.length);

    aaa = pageAnchor;

    var tabContainerDiv = $(pageAnchor).closest("div.content");
    console.log(url); 
    $.ajax({

      type: 'POST',
      url: url,
      datatype: 'html',
      data: {

        title: "{{title}}",
        filetype: filetype,
        page_no: page_no,
        no_of_objs_pp: no_of_objs_pp,
        csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(data){
        
        $(tabContainerDiv).html(data);

        // making newly loaded html pagination <a> non clickable and bind with populateFileList()
        $(tabContainerDiv).find("ul.pagination a").click(function(e){
          e.preventDefault();
          populateFileList(this);
        });

      }
    })

}

// </script>

{% endblock %}