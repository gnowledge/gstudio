{% load ndf_tags %}
{% load i18n %}

    <div id="upload_picModal" class="reveal-modal medium alert-box radius" data-reveal data-alert>
        <label id="upload_picModalLabel"></label>
        <a class="close-reveal-modal">&#215;</a>
    </div>
        <div class="text-center">

        <div class="div-height">
          {% if prof_pic_obj %}
                  <img src="{% url 'getFileThumbnail' group_id prof_pic_obj.pk %}" class="img-height"/>
          {% else %}
              {% if "Author" in group_object.member_of_names_list %}
                  <i class="fi-torso style2 text-center"></i>
              {% else %}
                  <img src="/static/ndf/images/metaStudio-profile.svg" alt="Profile picture for this group."  class="img-height">
              {% endif %}   
          {% endif %}   
        </div>
        {% if request.user.is_authenticated %}
        {% check_is_gstaff groupid request.user as gstaff_access %}
        {% if "Author" in group_object.member_of_names_list and user_id == request.user.id or "Author" not in group_object.member_of_names_list and gstaff_access %}
                <div class="row" >
                  <div class="small-12 columns" >
                    <input type="button" class="button tiny expand margin-p5 btn-font" id="{{widget_for}}_btnUploadProfilePic"  value="{% if prof_pic_obj %}Change{% else %}Upload{% endif %}">
                  </div>
                </div>
            {% endif %}
            <div id="{{widget_for}}_prof_pic_prop" class="reveal-modal medium" data-reveal style="height:500px;"> 
                <a href="#" id="{{widget_for}}_upload_photo">
                  <div id="upload-photo-div" class="text-center">
                    <label class="upload_photo_lbl fi-upload">Upload New Photo</label>
                  </div>
                </a>
                {% if old_profile_pics %}
                <fieldset id="{{widget_for}}_existing-photo-fieldset">
                    <legend class="choose_photo_lbl">Choose Any Existing Photo</legend>
                    <div class="existing-photo-div"  style="display:inline-block;overflow-y: auto;height:320px;">
                      {% for each_prof_pic in old_profile_pics %}
                        <div class="old_img">
                          <img src="{% url 'getFileThumbnail' group_id each_prof_pic.pk %}" style="height:150px;width:100px;" />
                          <div class="{{widget_for}}_prof_pic_select">
                          <input type="button" value="Use this" class="button tiny use_old_img_btn" onclick="update_img('{{each_prof_pic.pk}}')" />
                          </div>
                        </div>
                      {% endfor %}
                    </div>
                </fieldset>
                {% endif %}
                <div id="{{widget_for}}_pic_div" class="hide row">
                    <form class="dropzone" id ="{{widget_for}}_docPost" enctype="multipart/form-data" method="post"  action="{% url 'upload_prof_pic' group_id %}">
                        {% csrf_token %}
                        <input type="file" name="has_profile_pic" id="{{widget_for}}_docFile" accept="image/*" class="hide" />
                        <div class="{{widget_for}}_upload_cancel_div">
                            <img id="{{widget_for}}_img_preview" src="#" alt="New profile photo" />
                            <input type="submit" id="{{widget_for}}_submitpostid" value="Save" style="margin-left:2rem;" class="button tiny margin-p5" />
                            <input type="button" class="button tiny margin-p5" id="{{widget_for}}_btnUploadCancel" value="Cancel">
                        </div>
                        <input type="hidden" name="type" value="profile_pic">           
                        <input type="hidden" name="user" value="{{usr}}">
                        {% if url_name %}
                        <input type="hidden" name="url_name" value="{{url_name}}">
                        {% endif %}

                    </form>
                </div>
                <p id="{{widget_for}}_message" style="display:none">
                  {% trans "Your profile photo is uploading. Please wait.." %}
                </p>

                <a class="close-reveal-modal">&#215;</a>
            </div>

        {% endif %}
        </div>

<style type="text/css">
    div.reveal-modal > label {
      color: white;
      font-weight: bold;
      font-size: 1rem;
    }

    #upload-photo-div{
      height: 50px;
      border: 2px solid #0b8a91;
    }

    .choose_photo_lbl{
      color: #0b8a91;
    }

    .img-height {
        height: 100%;
    }
  
    .btn-font{
      font-size:15px !important;
    }

    .div-height {
        margin-bottom: 0.5em; 
        height: 9em;
    }


    .upload_photo_lbl{
      color: #0b8a91;
      font-size:30px;
    }

    .old_img{    
        border: 2px solid #0b8a91;
        display:inline-block;
        position:relative;
    }

    .use_old_img_btn{
        position:absolute;
        bottom:-19px;
        right:0px;
        display:none;
    }    
    
</style>        

<script type="text/javascript">
  // Hover events over old profile pics ---------------------------------------------------------
  $(".old_img")
    .mouseover(function(){
    $(this).find(".use_old_img_btn").css("display","block");
    })

    .mouseout(function(){
    $(this).find(".use_old_img_btn").css("display","none");
    })

  // Upload/Change Profile photo ----------------------------------------------------------------
  $("#{{widget_for}}_btnUploadProfilePic").click(function() {
    console.log("Change btn clicked")
    $("#{{widget_for}}_prof_pic_prop").foundation('reveal', 'open');
  });

  // Cancel/Abort Profile pic Upload-------------------------------------------------------------
  $("#{{widget_for}}_btnUploadCancel").click(function() {
    $("#{{widget_for}}_pic_div").addClass("hide");
    $("#{{widget_for}}_upload_photo").removeClass("hide");
    $("#{{widget_for}}_existing-photo-fieldset").removeClass("hide");
    $("#{{widget_for}}_docFile").val("");
  });

  // Upload photo btn in overlay ----------------------------------------------------------------
  $("#{{widget_for}}_upload_photo").click(function() {
    console.log("demo")
    $("#{{widget_for}}_docFile").trigger("click");
    // $(this).addClass("hide")
    // $("#{{widget_for}}_existing-photo-fieldset").addClass("hide")
  })

  // Choose from already uploaded(old profile photos) files -------------------------------------
  function update_img(old_img_id){
    $('<input>')
      .attr('type','hidden')
      .attr('name','old_pic_ele')
      .attr('id','{{widget_for}}_old_pic_ele')
      .attr('value',old_img_id)
      .appendTo('form#{{widget_for}}_docPost');
    $("#{{widget_for}}_submitpostid").trigger("click");
  }


  //Upload file action validation ---------------------------------------------------------------
  $('#{{widget_for}}_docFile').on("change", function() {
    $("#{{widget_for}}_upload_photo").addClass("hide")
    $("#{{widget_for}}_existing-photo-fieldset").addClass("hide")
    console.log("{{widget_for}}_docFile change function")
    $("#{{widget_for}}_pic_div").removeClass("hide");
    file_mime_type = this.files[0].type;
    console.log(file_mime_type)
    if(file_mime_type.indexOf("image/") < 0){
      $("#{{widget_for}}_btnUploadCancel").click()
      var message = "{% trans 'Only image files should be selected for setting your profile picture!' %}"
      $("#upload_picModalLabel").text(message);
      $("#upload_picModal").addClass("alert");
      $("#upload_picModal").foundation('reveal', 'open');
    }
    else{
      //$('#txtSelectedFiles').val(this.value);
      console.log("hi")
      var reader = new FileReader();
      reader.onload = function (e) {
        $('#{{widget_for}}_img_preview')
          .attr('src', e.target.result)
          .width(150)
          .height(200)
          .removeClass("hide");
        };
      reader.readAsDataURL(this.files[0]);
    }
  });

  // Update profile photo -----------------------------------------------------------------------
  $("#{{widget_for}}_submitpostid").click(function() {
    upload_from_existing = $("#{{widget_for}}_old_pic_ele").length
    if($("#{{widget_for}}_docFile").val() != "" || upload_from_existing > 0) { 
      $("#{{widget_for}}_prof_pic_prop").foundation('reveal', 'close');
      $("#{{widget_for}}_message").show();
      $(".{{widget_for}}_upload_cancel_div").addClass("hide");
      $("#{{widget_for}}_btnUploadProfilePic").attr("disabled", "disabled");
      var message = "{% trans 'Please wait while your profile picture is updated..' %}"
      $("#upload_picModalLabel").text(message);
      $("#upload_picModal").addClass("success");
      $("#upload_picModal").foundation('reveal', 'open');
    }
    else {
      var message = "{% trans 'Please select an image to set it as a profile picture !' %}"
      $("#upload_picModalLabel").text(message);
      $("#upload_picModal").addClass("warning");
      $("#upload_picModal").foundation('reveal', 'open');
      $("#{{widget_for}}_btnUploadCancel").click();
      return false;
    }
  });

  // Reveal modal close event -------------------------------------------------------------------
  $(document).on('closed.fndtn.reveal', '.reveal-modal', function () {
    console.log("close-reveal-modal")
    $(this).removeClass("success").removeClass("alert").removeClass("warning");
  });
    
</script>
