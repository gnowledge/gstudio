{% load simple_filters %}
{% xextends "ndf/base.html" with first_body_column=0 %}

{% load i18n %}

{% block title %} {{title}} {% endblock title %}

{% block body_content %}

<script src="/static/ndf/bower_components/d3/d3.min.js"></script>
<script src="/static/ndf/js/saveSvgAsPng.js"></script>
<script src="/static/ndf/js/graphs_fn.js"></script>
<script src="/static/ndf/js/topojson.v1.min.js"></script>
<style>
#map {
  background-color: #fff;
  border: 1px solid #ccc;
}
.background {
  fill: none;
  pointer-events: all;
}
#countries, #states {
  fill: #cde;
  stroke: #fff;
  stroke-linejoin: round;
  stroke-linecap: round;
}
#countries .active, #states .active {
  fill: #89a;
}
#countries>path:hover{
  fill: rgb(142, 248, 121);
}
#organization {
  stroke-width: 0;
}
.city {
  fill: #345;
  stroke: #fff;
}
pre.prettyprint {
  border: 1px solid #ccc;
  margin-bottom: 0;
  padding: 9.5px;
}
#light_box{
  display: none;
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  margin: auto;
  width:50%;
  height: 50%;
}
#circles{
  z-index: 10;
}
</style>
<style>

.graph_cont div {
  font: 10px sans-serif;
  background-color: steelblue;
  text-align: right;
  padding: 3px;
  margin: 1px;
  color: white;
}

/*for pie chart*/
svg {
  width: 100%;
  height: 100%;
}

path.slice{
  stroke-width:2px;
}

polyline{
  opacity: .3;
  stroke: black;
  stroke-width: 2px;
  fill: none;
}


.axis {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }.axis {
    font: 10px sans-serif;
  }

  .axis path,
  .axis line {
    fill: none;
    stroke: #000;
    shape-rendering: crispEdges;
  }

#info_bar{
  display: none;
  position: absolute;
  width:100%;
  text-align: center;
  padding: 5px;
  background-color: #C5F0FF;
}
.fix_center{
  position: fixed;
  top:0;
  left:0;
  right:0;
  bottom:0;
  margin:auto;
}
#lightbox{
  display: none;
  position: fixed;
  z-index: 999;
  overflow: auto;
}
#lightbox .close_lb_btn{
  color: #AAAAAA;
  cursor: pointer;
  font-size: 2.22222rem;
  font-weight: bold;
  line-height: 1;
  position: absolute;
  top: 0.55556rem;
  right: 1.22222rem;
  text-decoration: none;
}
#modal_lb{
  position: relative;
  top: 50px;
  width: 90%;
  margin: 20px auto;
  border-radius: 5px;
  left: 0;
  background-color: #FFFFFF;
  padding: 1.25rem;
  border: solid 1px #666666;
}
#blackout_lb{
  z-index: -1;
  background-color: rgba(0,0,0,0.5);
}
</style>
<div id="info_bar"></div>
<a class="edit_btn button">Edit</a>
<div id="map"></div>

<script>
window.onload = function(){
  init_lb();
}

// Light box functions=======================================
function init_lb(){
  var ele = '<div id="lightbox" class="fix_center"> <div id="blackout_lb" class="fix_center"></div> <div id="modal_lb"><a class="close_lb_btn" aria-label="Close">&#215;</a><h3 class="header_lb"></h3><div class="content_lb"></div></div> </div></div>';
  $('body').append(ele);
  $('#lightbox .close_lb_btn, #blackout_lb').click(function(){
    close_lb();
  })
}
function open_lb(){
  $('body').css('overflow', 'hidden');
  $('#lightbox').fadeIn(0);
}
function close_lb(){
  $('body').css('overflow', '');
  $('#lightbox').fadeOut(0);
}

function set_content_lb(data){
  if(data.head === undefined){
    data.head = "";
  }
  if(data.content === undefined){
    data.content = "";
  }
  $('#modal_lb .header_lb').html(data.head);
  $('#modal_lb .content_lb').html(data.content);
}
// Light box functions================END=======================

var color = d3.scale.ordinal()
  .domain(["Lorem ipsum", "dolor sit", "amet", "consectetur", "adipisicing", "elit", "sed", "do", "eiusmod", "tempor", "incididunt"])
  .range(["#98abc5", "#8a89a6", "#7b6888", "#6b486b", "#a05d56", "#d0743c", "#ff8c00"]);

var objects = [
  {"name": "Object1", "value": 0},
  {"name": "Object2", "value": 1},
  {"name": "Object3", "value": 2},
]
var dataset = [
  [
    [{"label":"Lorem ipsum","value": 83},{"label":"dolor sit","value":16},{"label":"amet","value":54},{"label":"consectetur","value":60},{"label":"adipisicing","value":68},{"label":"elit","value":46},{"label":"sed","value":35},{"label":"do","value":89},{"label":"eiusmod","value":32},{"label":"tempor","value":30},{"label":"incididunt","value":20}],
    [{"label":"Lorem ipsum","value":93},{"label":"dolor sit","value":18},{"label":"amet","value":42},{"label":"consectetur","value":28},{"label":"adipisicing","value":70},{"label":"elit","value":72},{"label":"sed","value":3},{"label":"do","value":88},{"label":"eiusmod","value":24},{"label":"tempor","value":87},{"label":"incididunt","value":32}],
  ],
  [
    [{"label":"Lorem ipsum","value":20},{"label":"dolor sit","value":26},{"label":"amet","value":62},{"label":"consectetur","value":31},{"label":"adipisicing","value":7},{"label":"elit","value":32},{"label":"sed","value":88},{"label":"do","value":81},{"label":"eiusmod","value":72},{"label":"tempor","value":52},{"label":"incididunt","value":99}],
    [{"label":"Lorem ipsum","value":44},{"label":"dolor sit","value":10},{"label":"amet","value":13},{"label":"consectetur","value":60},{"label":"adipisicing","value":44},{"label":"elit","value":56},{"label":"sed","value":67},{"label":"do","value":46},{"label":"eiusmod","value":92},{"label":"tempor","value":49},{"label":"incididunt","value":16}],
  ],
  [
    [{"label":"Lorem ipsum","value":8},{"label":"dolor sit","value":90},{"label":"amet","value":29},{"label":"consectetur","value":58},{"label":"adipisicing","value":82},{"label":"elit","value":34},{"label":"sed","value":21},{"label":"do","value":85},{"label":"eiusmod","value":37},{"label":"tempor","value":51},{"label":"incididunt","value":27}],
  ]
];

var mapping =[
  {
    "dataset": 0,
    "graph_type": [0]
  },
  {
    "dataset": 1,
    "graph_type": [0, 1]
  },
  {
    "dataset": 2,
    "graph_type": [1]
  },
];

function graph_select_init(){
  load_obj();
  d3.select('#object_type').on('change', function(){
    var val = mapping[this.value];

    d3.select('#dataset').select('.opt_to_select')
      .html('');
    var ele = d3.select('#dataset').select('.opt_to_select');
    for(i=0 ; i< dataset[val.dataset].length; i++){
      ele.append('option')
        .attr('value',i)
        .html('Dataset '+ i);
    }

    d3.select('#graph_type').select('.opt_to_select')
      .html('');
    var ele = d3.select('#graph_type').select('.opt_to_select');
    for(i=0; i<val.graph_type.length; i++){
      ele.append('option')
        .attr('value', i)
        .html(graphs[i].name);
    }

    d3.select(".graph_cont").html('');

  });

  d3.selectAll('#dataset, #graph_type').on('change', function(){
    refresh_graphs();
  });
}

function load_obj(){
  d3.select('#object_type').select('.opt_to_select')
    .html('');
  var ele = d3.select('#object_type').select('.opt_to_select');
  for(i=0 ;i<objects.length; i++){
    ele.append('option')
      .attr('value',objects[i].value)
      .html(objects[i].name);
  }
}

function refresh_graphs(){
  var object_type, ds, graph_type;
  object_type = d3.select('#object_type').node().value;
  ds = d3.select('#dataset').node().value;
  graph_type = d3.select('#graph_type').node().value;
  if(ds != '' && graph_type != '')
    graphs.paint_graph(graph_type, dataset[mapping[object_type].dataset][ds]);

}
</script>


<script>
var states_code = {
  "AP":"Andhra Pradesh",
  "TL":"Telangana",
  "AS":"Assam",
  "bih":"Bihar",
  "chh":"Chhattisgarh",
  "del":"Delhi",
  "goa":"Goa",
  "guj":"Gujarat",
  "har":"Haryana",
  "hip":"Himachal Pradesh",
  "jak":"Jammu and Kashmir",
  "jha":"Jharkhand",
  "kar":"Karnataka",
  "ker":"Kerala",
  "map":"Madhya Pradesh",
  "mah":"Maharashtra",
  "man":"Manipur",
  "meg":"Meghalaya",
  "miz":"Mizoram",
  "nag":"Nagaland",
  "ori":"Orissa",
  "pun":"Punjab",
  "raj":"Rajasthan",
  "sik":"Sikkim",
  "tan":"Tamil Nadu",
  "tri":"Tripura",
  "utp":"Uttar Pradesh",
  "utt":"Uttarakhand",
  "web":"West Bengal"
}

var m_width = document.getElementById('map').getBoundingClientRect().width,
    width = 938,
    height = 450,
    country,
    state;
var dflt_zoom = [680, 250, 5];

var projection = d3.geo.mercator()
    .scale(150)
    .translate([width / 2, height / 1.5]);

var path = d3.geo.path()
    .projection(projection);

var svg = d3.select("#map").append("svg")
    .attr("id","main_svg")
    .attr("preserveAspectRatio", "xMidYMid")
    .attr("viewBox", "0 0 " + width + " " + height)
    .attr("width", m_width)
    .attr("height", m_width * height / width);

svg.append("rect")
    .attr("class", "background")
    .attr("width", width)
    .attr("height", height)
    .on("click", state_clicked2);

var g = svg.append("g");

d3.json("/static/ndf/js/india_map.topo.json", function(error, states) {
  g.append("g")
    .attr("id", "countries")
    .selectAll("path")
    .data(topojson.feature(states, states.objects.collection).features)
    .enter()
    .append("path")
    .attr("id", function(d) { return d.id; })
    .attr("d", path)
    .on("click", state_clicked)
    .on('mouseover', function(d){
      if(!$('#info_bar').hasClass('disabled')){
        $('#info_bar').text(d.properties.name);
        $('#info_bar').show();
      }
    })
    .on('mouseout', function(d){
      $('#info_bar').hide();
    })
  g_cir = g.append("g").attr("id", "circes_group");
  zoom(dflt_zoom);
  load_organization();
});

$(document).on("click",".city",function(){
  data = {
    "head":"Analytics",
    "content":'<div id="main_container">\
        <div class="select_wrapper">\
          <select id="object_type">\
            <option disabled selected value> -- select an option -- </option>\
            <optgroup class="opt_to_select"> </optgroup>\
          </select>\
          <select id="dataset">\
            <option selected value=""> -- select an option -- </option>\
            <optgroup class="opt_to_select"> </optgroup>\
          </select>\
          <select id="graph_type">\
            <option selected value=""> -- select an option -- </option>\
            <optgroup class="opt_to_select"> </optgroup>\
          </select>\
        </div>\
        <div class="graph_cont">\
        </div>\
      </div>',
  }
  set_content_lb(data);
  graph_select_init();

  open_lb();
});
$(document).on("click",".edit_city",function(){
  curr_edit = d3.select(this);
  data = {
    "head":"Edit City",
    "content":'Name: <input id="city_name" type="text" /> \
            State: \
            <select id="state_list">\
            <option name="TL">Telangana</option></select><br>\
            <a class="save_btn button">Save</a>',
  }
  set_content_lb(data);

  var dt = curr_edit.data()[0];
  $('#city_name').val(dt.properties.name);
  $('#state_list').val(dt.properties.state);
  open_lb();
});
$(document).on("click",".save_btn",function(){
  var dt = curr_edit.data()[0];
  dt.properties.name = $('#city_name').val();
  dt.properties.state = $('#state_list').val();
  curr_edit.data(dt);
  close_lb();
  update_organization(dt,dt.id);

});

function zoom(xyz) {
  g.transition()
    .duration(750)
    .attr("transform", "translate(" + projection.translate() + ")scale(" + xyz[2] + ")translate(-" + xyz[0] + ",-" + xyz[1] + ")")
    .selectAll(["#countries", "#states", "#organization"])
    .style("stroke-width", 1.0 / xyz[2] + "px")
    .selectAll(".city")
    .attr("d", path.pointRadius(20.0 / xyz[2]));
}

function get_xyz(d) {
  var bounds = path.bounds(d);
  var w_scale = (bounds[1][0] - bounds[0][0]) / width;
  var h_scale = (bounds[1][1] - bounds[0][1]) / height;
  var z = .96 / Math.max(w_scale, h_scale);
  var x = (bounds[1][0] + bounds[0][0]) / 2;
  var y = (bounds[1][1] + bounds[0][1]) / 2 + (height / z / 6);
  return [x, y, z];
}

var pnt=true;
var organizations;
var curr_edit;
var curr = 0;
var g_cir;

$('.edit_btn').click(function(){
  if(pnt){
    $('.edit_btn').text('Exit edit mode');
    zoom(dflt_zoom);
    g.select("#organization").remove();

    g_cir = g.append("g")
      .attr("id", "edit_mode")

    g_cir.selectAll("circle")
      .data(organizations)
      .enter()
      .append("circle")
      .attr("r", "1.5")
      .attr("class", "edit_city")
      .attr("id", function(d) { return d.properties.name; })
      .attr("transform", function(d){ return "translate(" + d.coordinates[0] + "," + d.coordinates[1] + ")"})
      .call(drag);

    $('#info_bar').addClass('disabled');

    pnt = false;
  }
  else{
    $('.edit_btn').text('Edit');
    g.select("#edit_mode").remove();
    pnt = true;
  }
});
function state_clicked(d){
	if(pnt){
		state_clicked2(d);
		return;
	}
	if (d3.event.defaultPrevented) return;

	var point = d3.mouse(this)
	, p = {x: point[0], y: point[1] };
	// Append a new point
  dt = {
    properties:{
      name: "",
      state: "TL",
    },
    coordinates:[(p.x), (p.y)],
  };
	g_cir.append("circle")
		.data(dt)
		.attr("transform", "translate(" + p.x + "," + p.y + ")")
		.attr("r", "1.5")
		.attr("class", "edit_city")
		.style("cursor", "pointer")
		.call(drag);
}

var drag = d3.behavior.drag()
.on("drag", dragmove);
function dragmove(d) {
  var x = d3.event.x;
  var y = d3.event.y;
  d3.select(this).attr("transform", "translate(" + x + "," + y + ")");
}


function state_clicked2(d) {
  g.selectAll("#organization").remove();

  if (d && state !== d) {
    var xyz = get_xyz(d);
    state = d;
    state_name = d.id;

      g.append("g")
        .attr("id", "organization")
        .selectAll("circle")
        .data(organizations.filter(function(d) { return state_name == d.properties.state; }))
        .enter()
        .append("circle")
        .attr("r", "0.5")
        .attr("class", "city")
        .attr("id", function(d) { return d.properties.name; })
        .attr("transform", function(d){ return "translate(" + d.coordinates[0] + "," + d.coordinates[1] + ")"})

      zoom(xyz);
      $('#info_bar').addClass('disabled');

  } else {
    state = null;
    zoom(dflt_zoom);
    $('#info_bar').removeClass('disabled');
  }
}

window.onresize = function() {
  var w = document.getElementById('map').getBoundingClientRect().width;
  svg.attr("width", w);
  svg.attr("height", w * height / width);
};

var x;
function load_organization(){
  $.ajax({
    url: '/{{groupid}}/state_analytics/fetch_organization',
    method: 'GET',
    success: function(data){
      console.log(data);
      var det = JSON.parse(data);
      for(i=0; i<det.length; i++){
       det[i] = JSON.parse(det[i]);
      }
      organizations = det;
    }
  });
}


function update_organization(data,id=''){
  $.ajax({
    url: '/{{groupid}}/state_analytics/update_organization/' + id,
    method: 'POST',
    data: JSON.stringify(data),
    success: function(data){
      console.log(data);
    }
  });
}



</script>
{% endblock body_content %}
