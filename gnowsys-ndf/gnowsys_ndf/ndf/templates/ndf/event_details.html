{% extends "ndf/event.html" %}
{% load ndf_tags %}
{% load i18n %}
{% load pagination_tags %}
{% load static %}
{% get_static_prefix as STATIC_PREFIX %}
{% block head %}  

  <!-- Scripts required for D3 graph -->
  <script type="text/javascript" src="/static/ndf/bower_components/d3/d3.min.js"></script> <!-- checked -->
  <script type="text/javascript" src="/static/ndf/bower_components/underscore/underscore.js"></script> <!-- checked -->
  <script type="text/javascript" src="/static/ndf/bower_components/FileSaver/FileSaver.js" ></script> <!-- checked -->

{% endblock %}


{% block body_content %} 
<style>
table, th, td {
   border: 1px solid #F5F5DC;
} 
</style>

<div id="view_event">

  {% if user.is_authenticated %}
  <a id="toggle-shelf" class="right-off-canvas-toggle right" ><i class='fi-book-bookmark'></i></a> 
  {% endif %}

  <header class="row event">
    <section class="medium-12 columns" >
      <h2>
        <span class='node'>{{node.name}}</span>      
        <small class="label-list"> 
        {% for tag in node.tags %}
        <a href="{% url 'tag_info' groupid tag %}"><span class="label">{{tag}}</span></a>
        {% endfor %}
        </small>      
      </h2>

      <dl class="row tabs" data-tab data-options="deep_linking:true">
        <dd class="active"><a href="#view-page"><i class="fi-eye"></i> {% trans "Read" %}</a></dd>
        <dd onClick="controler()"><a href="#view-Attendance"><i class="fi-Attendance"></i>{% trans "Attendance" %} </a></dd>
        
      </dl>
    </section>
  </header> 
  
  <div class="row">

    

      <div class="tabs-content">

                  <div class="content active" id="view-page">
                      <section class="medium-9 columns">    
                       <fieldset>   
                          <ul class="inline-list">
                          {% if user.is_authenticated %}
                          {% block add_list %}{% endblock %}
                          {% endif %}
                          </ul>

                          <div class="row">
                            <div class="small-3 columns">
                              <label>Start time:</label> 
                            </div>
                            <div class="small-5 end columns">
                              <label>{{node.start_time}}</label> 
                            </div>
                          </div>

                          <br>
                          <div class="row">
                            <div class="small-3 columns">
                              <label>End time:</label>
                            </div>
                            <div class="small-5 end columns">
                              <label>{{node.end_time}}</label>
                            </div>
                          </div>

                          <br>
                          <div class="row">
                            <div class="small-3 columns">
                              <label>Event organised by:</label>
                            </div>
                            <div class="small-5 end columns">
                              {% for details in node.event_organised_by %}
                                <label>
                                {% if forloop.counter != 1 %}
                                
                                {% endif %}
                                {{details.name}}
                                </label>
                              {% endfor %}
                            </div>
                          </div>
                          
                         <br> 
                         {% if node.event_coordinator %} 
                          <div class="row">
                            <div class="small-3 columns">
                              <label>Event Co-ordinator:</label>
                            </div>
                            <div class="small-5 end columns">
                              {% for details in node.event_coordinator %}
                                <label>
                                {% if forloop.counter != 1 %}
                                {% endif %}
                                {{details.name}}
                                </label>
                              {% endfor %}
                            </div>
                          </div>
                          {% endif %}
                           <br>
                          <div class="row">
                            <div class="small-3 columns">
                              <label>Batch:</label>
                            </div>
                            <div class="small-5 end columns">
                              <label>{{batch}}</label>
                            </div>
                          </div>
                            <br>
                        <div class="row">
                            <div class="small-3 columns">
                              <label>Course:</label>
                            </div>
                            <div class="small-5 end columns">
                              <label>{{course.name}}</label>
                            </div>
                          </div>
                          <br>
                         <div class="row">
                            <div class="small-3 columns">
                              <label>Min marks:</label>
                            </div>
                            <div class="small-3 end columns">
                              <label>{{course.attribute_set.7.max_marks}}</label>
                            </div>
                            
                            <div class="small-3 columns">
                              <label>Max Marks:</label>
                            </div>
                            <div class="small-2 end columns">
                              <label>{{course.attribute_set.6.min_marks}}</label>
                            </div>
                       </div>
                        
                          <br>
                          <br>
                          {% with node.html_content|safe as description %}
                          {% if description != "None" %}
                          <label>Brief description about event:</label>
                          {{ description }}
                          {% endif %}
                          {% endwith %}
                    
                    </fieldset>   
                    </section>
                   
                    <section class="medium-3 columns">
                      <div class="panel">
                        <p>
                        {{ node.member_of_names_list.0 }} 
                        Edited {{ node.last_update|timesince }} ago by <a class="user" href="{% url 'dashboard' node.modified_by %}">{{node.user_details_dict.modified_by}}</a>
                        <br>
                        <small>
                          <a href="#view-changes"><i class="fi-clock"></i> Versions </a>
                          {% for seq_no, version_no in node.version_dict.items|slice:"-6:" reversed %}
                          <abbr title="Version #{{version_no}}">
                            {% if forloop.last and forloop.counter > 5 %}
                            <a href="{% url 'node_version' group_name_tag node.pk version_no %}" style="padding-left:5px;">. . .</a>
                            
                            {% else %}
                            <a href="{% url 'node_version' group_name_tag node.pk version_no %}" style="padding-left:5px;">{{version_no}}</a>

                            {% endif %}
                          </abbr> 
                          {% endfor %}
                        </small>
                      </p>
                      </div>

                      <!-- Start of Block: For listing Editing options --> 
                      {% check_is_gstaff groupid request.user as gstaff_access %}

                      {% edit_policy groupid node request.user as status %}
                      {% if user.is_authenticated and status == "allow" and gstaff_access %}
                        <div id = 'Edit' hidden> 
                              <a href="{% url 'event_app_instance_edit' groupid  app_set_id node %}" class="small button split edit">
                               <i class="fi-pencil"></i> Edit <span data-dropdown="edit-options"></span>
                              </a>
                        </div>
                        <div id='reschedule'>
                        </div>
                        <div id="countdown">
                               <label id="message" style="color:red;"> Event-Reschedule would be closed after:</label>
                               <label id='date'>  </label>     
                             
                        </div>
                        <ul id="edit-options" class="f-dropdown">

                          <li>
                            <a class="button small expand" href="{% url 'event_app_instance_create' groupid app_set_id %}">
                            <span class="fi-plus">&nbsp;&nbsp; New {{node.member_of_names_list.0}}</span>
                            </a>
                          </li>

                        </ul>
                      {% endif %}
                    </section>
 
                  </div> <!-- End of class="content active" -->

                 <div class="content" id="view-Attendance" >    
                        
                        <div id="attendance">
                            
                        </div>
                        
                        <div id="atten_asses_cmpl">
                        </div>
                      
                      </div>
                      <!-- Tab View Map Widget -->
                 </div> <!-- End of class="tabs-content" -->
      </div>

</div>

{% endblock %}

{% block script %}
 eventreschedule=""
 <!-- start_time is the time after which event would close -->
 <!-- if start_time of session is passed and a reschedule is allowed -->
 <!-- then the start _time would be reschdule time after which the event would close -->
 
          
 start_time = '{{node.start_time|date:"c" }}'
 reschdule_time = '{{reschedule_time|date:"c"}}'
 nIntervId = setInterval(enable_disable_edit, 500);
 start_time1()

 function start_time1()
  {
    <!-- would decide the close time of the event -->  
     current_datetime = new Date (Date())
     save_date = new Date(start_time)
     reschedule_date = new Date('{{reschedule_time|date:"c"}}')
     if (current_datetime < save_date) 
       {
         
          close_time = save_date 
       } 
     else if ( current_datetime < reschedule_date)
       {
          close_time = reschdule_time
       }
     else 
      {
 
        close_time = ""
      }
  }
          
 function enable_disable_edit()
  {
    <!--  this method whould decide wheather check time of disable edit -->
   if (close_time) 
    {
    current_datetime = new Date (Date())
    save_date = new Date(close_time)
      if ( current_datetime < save_date )
      {
        flashText()     
        $('#Edit').show()
      } 
    
     }

    if (current_datetime > save_date  || !(close_time) )
      {
          
          $('#Edit').hide()
          $('#countdown').hide()
          $('#reschedule').append("<input class='tiny button' onclick=reschedule_event('event_reschedule') value='Reschedule'>")
          clearInterval(nIntervId);        
         if ('{{reschedule}}' == 'True')
           { 
              closeEvent()
           } 
      }  
    


  }

 function flashText()
  { 
      
      <!-- method to show the remaining time after which edit option would be closed -->
      <!-- take the difference -->
      current_datetime = new Date (Date())
      save_date = new Date(close_time)
      var difference = current_datetime.getTime() - save_date.getTime();
      <!-- gets the hours mins second remaing for event to close -->
      var daysDifference = Math.floor(difference/1000/60/60/24);
      var dayDifference = -daysDifference 
      difference -= daysDifference*1000*60*60*24
      var hoursDifference = Math.floor(difference/1000/60/60);
      difference -= hoursDifference*1000*60*60
      var minutesDifference = Math.floor(difference/1000/60);
      difference -= minutesDifference*1000*60 
      var secondsDifference = Math.floor(difference/1000);

      $('#date').empty()

      if ( dayDifference > 0)
      {
        $('#date').append("<h4>" + save_date.toDateString() + "," + " "+ ( 23 - hoursDifference  ) + " : "+ (59 - minutesDifference ) + ":" + (60 - secondsDifference) + "</h4>")
      }
      
      if ( dayDifference <= 0)
      {
        $('#date').append( ( 23 - hoursDifference  ) + " : "+ (59 - minutesDifference ) + ":" + (60 - secondsDifference))
      }
      
  }   

function closeEvent()
{

    $.ajax({

               url:"{% url 'close_event' groupid node %}",
               type: "POST",
               data:{
               csrfmiddlewaretoken: '{{ csrf_token }}'},
               success: function(data){
               }

          });
    
}
function controler()
{
          //checks wheather the has_attende relation is createad or not 
          //this confirms that attendance is being taken 
         
          
          $.ajax({
                      url: "{% url 'attendees_relations' groupid node %}",
                      type: "GET",
                      success: function(data){
                      attended=JSON.parse(data)
                      },
                      complete:function()
                      {
                      reschedule = attended[2]
                      marks_enter = attended[3]
                      if (attended[0] == 'True')
                      {
                          EditAttendance(attended)             
                      }
                      else
                      {
                          EditAttendance(attended)        
                      }
                      
                      }
              
                });


}

function EditAttendance(columns)
{

        $.ajax({
                      url: "{% url 'get_attendance' groupid node %}",
                      type: "GET",
                      dataType: "json",
                      success: function(data){
                      data
                      attended=data
                      $('#attendance').empty()
                      },
                      complete:function(){
                      $('#attendance').append("<table id='forattendance'> </table>")
                      drawTable(attended,columns)
                      if(reschedule == false)
                      {
                          disableAttendance();
                      }
                      }
          });

}

function disableAttendance()
{
    $(':checkbox.chkbx').each(function () 
    { this.disabled = true})
     
}

function drawTable(attended,columns)
{
if ( (columns == 'Edit') == false ){
      pass=columns
}
else
{
    pass[0] ='Edit'
}
column1="<th> name </th>"
column2="<th> Presence </th>"
column3="<th> Assignment Marks </th>"
column4="<th> Assessment Marks </th>"
     if(pass[1] == 1)
      {
        column3= " " 
        column4= " " 
     
      }
      if (pass[1] == 2)
      {
         
     }
      if (pass[1] == 4 || pass[1] == 5 )
      {
       column3=""
      }
      if (pass[1] == 3 )
      {
       column4=""
      }
       $('#forattendance').append("<thead><tr>"+ column1+column2+column3+column4 + "</tr></thead>")  
       $.each(attended, function(key,val) {
       column1_data="<td>" + val.name +"</td>"
       column2_data="<td> " + val.presence + "</td >"
       column3_data="<td class='Assigntxtbx'> " + val.Assignment_marks + "</td >"
       column4_data= "<td class='Assesstxtbx'> "  + val.Assessment_marks + "</td > " 
       column3data="<td><input type='number' onblur='validate_txtbx(this)'  class='Assigntxtbx' id="+val.id+"Assignment" + " value= "+ val.Assignment_marks + " </td>"
       column4data="<td> <input type='number' onblur='validate_txtbx(this)'  class='Assesstxtbx' id="+val.id+"Assessment" +" value= "+ val.Assessment_marks + " </td>"  
      
      

     if(pass[1] == 1)
      {
        column3data = " " 
        column3_data= " " 
        column4_data= " " 
        column4data = ""
      }
      if (pass[1] == 2)
      {
         
      }
      if (pass[1] == 4 ||pass[1] == 5 )
      {
       column3_data=""
       column3data=""
      }
      if (pass[1] == 3 )
      {
       column4_data=""
       column4data=""
      }     
if ( pass[0] == 'Edit'){

          
                     if(val.presence == 'Absent')
                              {
                    $('#forattendance').append("<tr><td>" + val.name +"</td>  <td> <input type='checkbox' onClick='enablemarks(this)' class='chkbx'  value=" + val.id + " ></td>  " 
                  + column3data + column4data + " </tr>")
                            
                            
                            if (document.getElementById(val.id+"Assignment")){
                                  document.getElementById(val.id+"Assignment").disabled = true;
                                }
                            else
                                {}
                            if (document.getElementById(val.id+"Assessment"))
                               {
                                            document.getElementById(val.id+"Assessment").disabled = true;
                               }
                            else
                               {} 
                  
                             }
                     else
                              {
                                        $('#forattendance').append("<tr><td>" + val.name +"</td>  <td> <input type='checkbox' onClick='enablemarks(this)' class='chkbx'  value=" + val.id + " checked></td >  " 
            + column3data  + column4data + "</tr>")
                              }
                                 

}
else{

       
       
       $('#forattendance').append("<tr>"+ column1_data + column2_data + column3_data + column4_data   + "</tr>")         

    }
  });
  
if ( pass[0] == 'Edit'){
      if (pass[1] == '2' || pass[1] == '4' || pass[1] == '3')
      {
        $('#attendance').append("<div class='row'>" 
         + "<div class='small-8 columns'> "
         + " <fieldset>   "
         + " <input type='checkbox'  class='assessmentchkbx' id='assessmentchkbx'> Assessment Done"
         + " <br> <span style='color:red;'> Note:- Edit option will be closed after asessment is done. </span> "
         + " </fieldset> </div></div>")
      }
        $('#attendance').append("<br>")
        $('#attendance').append("<input class='tiny button' onclick='saveattendees("+pass[1]+")' value='Save' >")
        $('#attendance').append("<input class='tiny button' onclick='TakePrint()' value='Print'>")
                   

}
else
{     
        
      $('#attendance').append("<input class='tiny button' id='d' onclick='Download("+pass[1]+")' value='Download'>")
      
      if(reschedule == true || marks_enter  == true){
            if(marks_enter != false)
            {
              $('#attendance').append("<input class='tiny button' id='d' onclick=EditAttendance('Edit') value='Edit'>" )
            }
      }
      if(reschedule == false || marks_enter == false)
      {
        $('#attendance').append("<input class='tiny button'  onclick=reschedule_event() value='Re-Schedule'>" )
      }
          
      
}


}

function reschedule_event(type)
{
    $.ajax({
             url:"{% url 'reschedule_task' groupid node.pk  %}",
             type:"POST",
             data:{
                 path:'{{request.path}}',
                 reschedule_type:type,
                 csrfmiddlewaretoken: '{{ csrf_token }}'
                },
             success:function(data)
             {
              alert(data) 
              if (data == 'Event Dates Re-Schedule Opened')
                 {
                    location.reload()
                  
                 }
              if ( type != 'event_reschedule') 
                  {
                   controler()
                  }
             }
         });
  
}

function enablemarks(value)
{

if (value.checked == true)
{
  if (document.getElementById(value.value+"Assignment")){
  document.getElementById(value.value+"Assignment").disabled = "";
  }
  if (document.getElementById(value.value+"Assessment")){
       document.getElementById(value.value+"Assessment").disabled = "";}
     }
else
{
  if (document.getElementById(value.value+"Assignment")){
  document.getElementById(value.value+"Assignment").disabled = true;
  document.getElementById(value.value+"Assignment").value = '0';
  }
  if (document.getElementById(value.value+"Assessment")){
     document.getElementById(value.value+"Assessment").disabled = true;
     document.getElementById(value.value+"Assessment").value = '0';
  }
}
}

function Download(save)
{
var Event_attended_by = [];
var column=[]    
    var table = document.getElementById("forattendance");
    
    column.push('Name')
    column.push('Presence')
    if (save ==2 || save == 3){
      column.push('Assignment Marks')
      } 
      if (save == 2 || save == 4) { 
        column.push('Assessment_marks')
        }
         
    $("#forattendance").find('tr').each(function(){
   
    var Names_attended = $(this).find('td:eq(0)').text()
    var Status_attended = $(this).find('td:eq(1)').text()
  /* if (!(Status_attended))
    {
      Status_attended='Absent'
    }
    else
    {
      Status_attended='Present'
    }*/
   
    var values = '{"Name":"'+ String(Names_attended) +'","Presence":"'+String(Status_attended)
    if ( save ==  2 || save == 3){
      var Attendance_marks = $(this).find('td:eq(2)').text()
      values = values + '","Assignment Marks":"'+String    (Attendance_marks) 
    }
    if (save ==  2 || save == 4){ 
       if (save == 4){
       var Assessment_marks = $(this).find('td:eq(2)').text()
       }
       if (save == 2)
       { 
         var Assessment_marks = $(this).find('td:eq(3)').text()
       
       }
       values = values + '","Assessment_marks":"' + String(Assessment_marks) 
     }
   
    
      /*var values = '{"Name":"'+ String(Names_attended) +'","Presence":"'+String(Status_attended)+'","Attendance_marks":"'+String(Attendance_marks) + '","Assessment_marks":"' + String(Assessment_marks) +'","save":"'+save_val +'"}'
    */
   values = values + '"}'
   Event_attended_by.push(values)
    });

 val_data = ""
 $.ajax({
      url: "{% url 'save_csv' groupid node.pk %}",
      type: "POST",
      data:{attendance:Event_attended_by,
      column:column, 
      csrfmiddlewaretoken: '{{ csrf_token }}'
      },
      success: function(data){
        val_data = data
      },
        complete: function(){
     document.location.href=val_data
       
      }
    
      
    });

}
function TakePrint()
{
     var printContents = document.getElementById("attendance").innerHTML;
     var originalContents = document.body.innerHTML;

     document.body.innerHTML = printContents;
     window.print();
     document.body.innerHTML = originalContents;
}

function saveattendees(save_val)
{var attendees_list = [];
var  absentees_list=[];
var student_marks=[]
var student_id=[]
var eventid=[]
var Event_attended_by=[]
var assessmentdone=""
var attendancedone=""
eventid='{{node.pk}}'
title='{{app_set_id}}'

    var url="{% url 'event_assginee' groupid  node.pk  %}"
    
    $("#forattendance").find('tr').each(function(){
    var Names_attended = $(this).find('.chkbx').val()
    var Status_attended = $(this).find('.chkbx:checked').val()
    var Attendance_marks = $(this).find('.Assigntxtbx').val()
    var Assessment_marks = $(this).find('.Assesstxtbx').val()
    
   
if (!(Status_attended))
    {
      Status_attended='False'
    }
    else
    {
      Status_attended='True'
    }
     var values = '{"Name":"'+ String(Names_attended) +'","Presence":"'+String(Status_attended)+'","Attendance_marks":"'+String(Attendance_marks) + '","Assessment_marks":"' + String(Assessment_marks) +'","save":"'+save_val +'"}'
    Event_attended_by.push(values)
    }); 
    
    if ($('#assessmentchkbx').is(':checked')) 
    {
    assessmentdone='True'
    }
       
   
     if(Event_attended_by !="")
     {
              $.ajax({
                      url: url,
                      type: "POST",
                      data:{
                      marks:'{{marks_enter}}',
                      assessmentdone:assessmentdone,
                      Event_attended_by:Event_attended_by,
                      Event:eventid,
                      csrfmiddlewaretoken: '{{ csrf_token }}'},
                      success: function(data){
                      alert(data)
                      controler()
                      }
                    });
     }
     else
     {
     alert("No Attendance Taken.")
     }
    
    
    
 }
    
   
function validate_txtbx(input)
{ 
    
  if ( Number(input.value) >= Number('{{course.attribute_set.6.min_marks}}') && Number(input.value) <= Number('{{course.attribute_set.7.max_marks}}') )
  {
    
  }
  else
  {
    document.getElementById(input.id).value = "0" 
     alert("Please Enter valid marks Between Min and Max Marks!")
  }
}
   
$(document).on('opened', '#view-map-edit-widget[data-reveal], #view-map-widget[data-reveal]', function () {  
  
  map.invalidateSize();  
});
{% endblock %}	
