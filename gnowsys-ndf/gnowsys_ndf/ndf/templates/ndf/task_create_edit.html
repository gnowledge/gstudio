{% extends "ndf/base.html" %}
{% load pagination_tags %}
{% load ndf_tags %}
{% load i18n %}

{% block title %} {{title}} {% endblock %}

{% block head %}
	<script type="text/javascript" src="/static/ndf/bower_components/jquery-ui/jquery-ui.min.js"></script> <!-- checked -->
	<script type="text/javascript" src="/static/ndf/bower_components/foundation-datepicker/js/foundation-datepicker.js"></script> <!-- checked -->
	<link rel="stylesheet" type="text/css" href="/static/ndf/bower_components/foundation-datepicker/stylesheets/foundation-datepicker.css"> <!-- checked -->
	<link rel="stylesheet" type="text/css" href="/static/ndf/bower_components/jquery-ui/themes/smoothness/jquery-ui.min.css"> <!-- checked -->

  <script src="/static/ndf/bower_components/jquery-ui/jquery-ui.js"></script> <!-- checked -->
  <script src="/static/ndf/bower_components/jqueryui-timepicker-addon/dist/jquery-ui-timepicker-addon.min.js"></script> <!-- checked -->
  <script src="/static/ndf/bower_components/jqueryui-timepicker-addon/dist/jquery-ui-sliderAccess.js"></script> <!-- checked -->
  <link rel="stylesheet" href="/static/ndf/bower_components/jqueryui-timepicker-addon/dist/jquery-ui-timepicker-addon.css"> <!-- checked -->
	<link rel="stylesheet" type="text/css" href="/static/ndf/bower_components/jquery-ui/themes/smoothness/jquery-ui.css"> <!-- checked -->
{% endblock %}

{% block style %}
  /* Setting css-properties for ui-datepicker */
    #ui-datepicker-div {
      box-shadow: 0 5px 5px #808080;
      width: 230px;
    }

    .ui-widget {
      font-family: inherit;
      font-size: inherit;
    }

    .ui-corner-all {
    
      border-radius: 0;
    }

    #ui-datepicker-div dt.ui_tpicker_minute_label {
    
      margin-bottom: 0;
    }

    .ui-slider-horizontal {
    
      margin-top: 1em;
    }

    .ui-datepicker-title select {
      background-color: #e6e6e6;
      /*border-collapse: separate;
      border-spacing: 30px 0px;*/
      font-family: inherit;
      /*font-size: 0.3em;*/
      font-weight: normal;
      height: 1.5rem;
      /*margin: 30px 0;*/
      padding: 0;
    }

  /* Resetting css-properties for fieldset (also legend, input) */
    /* fieldset (padding-bottom) */ 
    fieldset {
      padding: 1.25rem 1.25rem 1.25rem 1.25rem !important;
    }

    /* legend (background-color) */
    fieldset legend {
      background-color: transparent !important;
    }

    /* input (margin) */
    fieldset input {
      margin: 0 !important;
    }

  .watchers{
    max-height: 210px;
    overflow-x: hidden;
    overflow-y: auto;
    padding-left: 10px;
    width: 300px;
  }

  #list{
    max-height: 80px;
    overflow-x: hidden;
    overflow-y: auto;
    padding-left: 10px;
  }

	.selFile {
    border-radius: 1px;
    box-shadow: 3px 3px 3px 1px rgba(9,9,9,0.2);
  }
{% endblock %}

{% block meta_content %}
  <h3 class="subheader">{% trans "Task Editor" %} </h3>
{% endblock %}

{% block body_content %}
  <div id="myModal" class="reveal-modal" animation="None" data-reveal>
    <h3> Please wait till file is Uploading... </h3>                
  </div>

  <form data-abide id="form-edit-node" enctype="multipart/form-data" onSubmit="enableselect();" method="POST" action="">
    {% csrf_token %}

    <h2 class="medium-12 columns">
      {% if node %}
        Editing {{title}}: {{node.name}}
      {% else %}
        Create a New {{title}}
      {% endif %}
    </h2>

    <br/><br/><br/><br/>

    <div class="medium-6 columns end">
      <!-- Name -->
      {% if not task_id %}
    	<div class="row">
    	  <div class="medium-12 columns">
    	    <label>{{title}} Name <font color="red">*</font></label>
    	    <input id="name_id" name="name" type="text" value="{{node.name}}" placeholder="Enter name..." required>
    	    <small class="error">Please give your Task a descriptive name.</small>
    	  </div>
    	</div>
    	{% endif %}

      <!-- Parent task -->
    	<div class="row">
    	  <div class="medium-12 columns">
    	    <label>Parent task</label>
    	    <input id="parent" type="text" value="{{parent}}">
    	    <input type="hidden" name="parent" id="hidden_parent" value="{{parent_id}}">
    	  </div>
    	</div>

      <!-- Status & Start date -->
    	<div class="row">
    	  <div class="medium-6 columns">
    	    <label>Status <font color="red">*</font></label>
      		<select required="" class="medium" id="customDropdown" name="Status" data-invalid="">
      			<option selected="selected" value="New" id="New">New</option>
      			<option value="In Progress" id="In Progress">In Progress</option>
      			<option value="Resolved" id="Resolved">Resolved</option>
      			<option value="Feedback" id="Feedback">Feedback</option>
      			<option value="Closed" id="Closed">Closed</option>
      			<option value="Rejected" id="Rejected">Rejected</option></select>
      		</select>
      		<input type="hidden" name="myselect" value="myselectedvalue" />
      		<small class="error">Broke.</small>
    	  </div>

    	  <div class="medium-3 columns end">
    	    <label>Start date</label>
          <input id="start_date" class="date_month_day_year" type="text" placeholder="DD/MM/YYYY" value="" name="start_time" readonly="" {% if start_time %}disabled{% endif %}>
    	  </div>
    	</div>	

      <!-- Priority & Due date -->
    	<div class="row">
    	  <div class="medium-6 columns">
    	    <label>Priority <font color="red">*</font></label>
    	    <select required="" class="medium" id="customDropdown1" name="Priority" data-invalid="">
        		<option value="Low" id="Low">Low</option>
        		<option selected="selected" value="Normal" id="Normal">Normal</option>
        		<option value="High" id="High">High</option>
        		<option value="Urgent" id="Urgent">Urgent</option>
        		<option value="Immediate" id="Immediate">Immediate</option></select>
    	    </select>
    	  </div>

    	  <div class="medium-3 columns end">
    	    <label>Due date</label>
          <input id="end_date" class="date_month_day_year" type="text" placeholder="DD/MM/YYYY" value="" name="end_time" readonly="">
    	  </div>
    	</div>

      <!-- Assignee & Estimated time -->
    	<div class="row">
    	  <div class="medium-6 columns">
    	    <label>Assignee</label>
    	   	<select name="Assignee" class="medium" id="customDropdown2" data-invalid="">
            <option value="" selected="selected"></option>
    		  </select>
    	  </div>

    	  <div class="medium-3 columns end">
    	    <label>Estimated time</label>
    	    <input id="Estimated time" name="Estimated_time" type="text" value="{{Estimated_time}}" placeholder="Enter Hours..."/>
    	    <small class="error">Please give Time in HH:MM:SS</small>
    	  </div>
    	</div>
  	
      <!-- Group members listing -->
      {% get_existing_groups as groups %}
    	<div class="row" id="AssigneeType">	
    	  <div class="medium-12 columns">
    	    <fieldset>
            <legend>
              Select Memebers : <input type="checkbox" onClick='toggle(this)' id="selectAllOptions" checked="" /> Select/Deselect All
            </legend>
      
        		<div id="list">
        		  <!-- <input type="checkbox" value="" name= "author_Set" selected="selected"> --> 
        		</div>
          </fieldset>
      	</div>
      </div>

    	<!--
    	<div class="row">
    		<div class="medium-9 columns">	
    			<fieldset>
            <input type="radio" name="single" value="Single Assignee" onClick='toggle(this)'>Single Assignee &nbsp;&nbsp;&nbsp;
      			<input type="radio" name="single" value="Group Assignee" onClick='toggle(this)'>Group Assignee <br>
    			</fieldset>
    		</div>
      </div>
    	-->

      <!-- Upload files -->
      <div class="row">
        <div class="medium-12 columns">
          <input type="file" class="button small radius" name="UploadTask" onChange="handleFileSelect(this)" id="docFile" value= "" style="padding-right: 15rem;" />
          <div id="selectedFiles" style="margin-bottom: 20px;">
          </div>
        </div>
      </div>

      <!-- Describe -->
      <div class="row">
  	    <div id="contentlist" class="medium-12 columns content">
          <div class="">
            <label style="margin-left: -5px;margin-bottom: -15px;">{% trans "Describe" %}</label>
            {% include "ndf/add_editor.html" with var_name="content_org" var_placeholder="Enter the content here" var_value="" %}
    		  </div>
        </div>
  	  </div>

      <!-- Watchers list -->
    	{% if not task_id %}
    	<div class="row">
        <div class="medium-12 columns">
          <label>Watchers</label>

      		<div class="watchers">
          </div>
    	  </div>
      	<input type="hidden" name="watchers" id="hidden_watchers" value="">
      </div>
    	{% endif %}

      {% if Upload_Task %}
      	{% get_file_node request Upload_Task as new %}
        <div class="row">
        {% for node in new %}
        	{% get_grid_fs_object node as grid_fs_obj %}
        	<div id="Uploaded" class="medium-6 columns end">
          	<b><a href="{% url 'read_file' group_id node.pk grid_fs_obj.filename %}">{{grid_fs_obj.filename}}</a></b>
        	</div>
      	{% endfor %}
        </div>

      {% else %}
        <div class="row">
          <p class="medium-6 columns end">--</p>
        </div>

    	{% endif %}

      <!-- Hidden variables & Save button -->
      <div class="row" >
        <div class="medium-3 medium-centered columns">
          <!-- Hidden variables -->
          <input type="hidden" name="node" value="{{node.pk}}">
          <input type="hidden" name="user" value="{{user.id}}">
          <input type="hidden" name="files" id="trial" >
          <input type="hidden" name="files_name" id="filename" >
          <input type="hidden" name="page_url" value="{{request.path}}">

          <!-- Save button -->
          <input type="submit" id="save-node" value="Save" class="button small expand"/>
        </div>
      </div>
    </div>
  </form>
{% endblock %}

{% block script %}
  $("#parent").autocomplete({
    source: "{% url 'search_tasks' groupid %}" + $("#parent").val(),
    select: function(event, ui) {
      $('#hidden_parent').val(ui.item.id);
    } 
  });

  <!-- To prevent error while parsing to JSON, if group has no members -->
  user_list = update_user_list();
  if (JSON.stringify(user_list) != "[]") {
    user_list = JSON.parse(user_list);
  }

  else {
    user_list = [];
  }

  function update_user_list() {
    var ajurl = "{% url 'get_group_member_user' groupid %}";
    var users = [];
    
    $.ajax({
      url: ajurl,
      async: false,   
      success: function(data) {
        users = data;
      }
    });

    return users;
  }

  $.each(user_list, function(key,value) {
    $('#customDropdown2').append($("<option></option>")
                                  .attr("value", value)
                                  .text(value)
                                  .attr("id", value)
                                );

    var div = $("<div>" + "</div>").attr("class", "row").appendTo($(".watchers"));
    var input = $("<input>" + value).attr("type", "checkbox").attr("id", value).appendTo(div);
  });

  {% if parent %}
  var parent = document.getElementById("parent");
  parent.value = "{{parent}}";
  {% endif %}

  var selected = new Array();
  $(document).on("click", "#save-node", function(event) {
    $('form-edit-node input:checkbox:checked').each(function(){
      selected.push(this.id);
    });
    
    $('#hidden_watchers').val(selected);
  });

  var selDiv = "";
  var storedFiles = [];
  var selfiles = [];

  var currentYear = (new Date()).getFullYear();
  var lowerYearLimit = currentYear - 30;
  
  function attachedfiles() {
    //popultate the files with their names
      var sData = '{{Upload_Task}}';
      sData = sData.replace(/&quot;/g, '"');
      sData = jQuery.parseJSON(sData);
      if (sData) {
        for(i = 0; i < sData.length; i++) {
          storedFiles.push(sData[i]);
          
          var html_content = "<div>" +
                                "<span data-file='"+sData[i]+"' class='selFile' title='Click to remove'>" + 
                                  sData[i] + " &#215;" +
                                "</span>" +
                              "</div>";
          
          selDiv.append(html_content);
        }
      }

    //populate the list with their ids
      var sData = '{{select}}';
      sData = sData.replace(/&quot;/g, '"');
      sData = jQuery.parseJSON(sData);
      if (sData) {
        for(i = 0; i < sData.length; i++) {
          if(sData[i]) {
            selfiles.push(sData[i])
          }
        }
      }

    var select = document.getElementById('trial');
    select.value = selfiles;
    
    var files_name = document.getElementById('filename');
    files_name.value = storedFiles;
  }
  
  function handleFileSelect(e) {
    var files = e.files;
    var filesArr = Array.prototype.slice.call(files);
    
    filesArr.forEach(function(f) {  
      storedFiles.push(f.name);
      
      var reader = new FileReader();
      reader.onload = function (e) {
        var html = "<div>" + 
                      "<span data-file='"+f.name+"' class='selFile' title='Click to remove'>" + 
                        f.name + " &#215;" +
                      "</span>" + 
                    "</div>";
      
        selDiv.append(html);
      }

      reader.readAsDataURL(f); 
    });
    
    var files_name = document.getElementById('filename');
    files_name.value = storedFiles;
    
    var formData = new FormData();
    // Loop through each of the selected files.
      for (var i = 0; i < files.length; i++) {
        var file = files[i];
        formData.append('doc[]', file, file.name);
      }

    // appending csrfmiddlewaretoken and user-id
      formData.append('csrfmiddlewaretoken', '{{csrf_token}}');
      formData.append('user', '{{request.user.id}}');

    // Set up the request.
      xhr = new XMLHttpRequest();
      xhr.open('POST', "{% url 'save_image' group_name %}", true);
        
    // Set up a handler for when the request finishes sucessfully.
      $('#myModal').foundation('reveal', 'open');
  
      xhr.onload = function () {
        if (xhr.status === 200) {
          $('#myModal').foundation('reveal', 'close');      
          selfiles.push(xhr.responseText);
          
          var select=document.getElementById('trial');
          select.value=selfiles
        }
      }
      
      xhr.send(formData);
  }
    
  function removeFile(e) {
    var file = $(this).data("file");
    for(var i = 0; i < storedFiles.length; i++) {
      if(storedFiles[i] === file) {
        storedFiles.splice(i, 1);
        selfiles.splice(i, 1);
        break;
      }
    }

    $(this).parent().remove();

    var select = document.getElementById('trial');
    select.value = selfiles;
    
    var files_name = document.getElementById('filename');
    files_name.value = storedFiles;
    
    var select_docfile = document.getElementById('docFile');
    select_docfile.value = "";
  }

  function toggle(source) {
    if ((source.value) == 'Single Assignee') {
      document.getElementById("AssigneeType").style.visibility = "hidden";
      document.getElementById("group").style.visibility = "hidden";
    }

    else if ((source.value) == 'Group Assignee') {
      document.getElementById("AssigneeType").style.visibility = "visible";
      document.getElementById("group").style.visibility = "visible";

      var check = document.getElementById("AssignTaskGroup");
      check.checked = false;
    }

    /* Selects All the Assignes from the DropDown List */
      var x = document.getElementById("selectAllOptions").checked;
      var y = document.getElementById("customDropdown2");
      select_values("customDropdown2");
      checkboxes = document.getElementsByName('Assignee');
      for(var i = 0; i <= checkboxes.length; i++) {
        if (x == true) {
          checkboxes[i].checked = true;
        }
    
        else {
          checkboxes[i].checked = false;
          document.getElementById("list").innerHTML = "";
        }
      }
  }

  function select_values(source) {
    document.getElementById("list").innerHTML = ""; 
    
    var y = document.getElementById(source);
    var element = document.getElementById("list");
    var count = 0; 
    var fieldset = document.createElement("fieldset");

    for(var i = 1; i < y.length; i++) {
      count=count+1;

      var checkbox = document.createElement('input');
      checkbox.type = "checkbox";
      checkbox.name = "Assignee";

      var a = y[i].value;
      checkbox.value = a  ;
      checkbox.id = "id";

      var label = document.createElement('label');
      label.appendChild(document.createTextNode(String(y[i].value)));

      //fieldset.appendChild(checkbox);
      //fieldset.appendChild(label);
    
      element.appendChild(checkbox);
      element.appendChild(label);
  
      if (count == 4) {
        count = 0;
        element.appendChild(document.createElement("br"));
      }
    }
  }

  if ('{{node.name}}' == "") {
    document.getElementById("customDropdown").disabled = true;
  }

  function enableselect() {
    document.getElementById('customDropdown').disabled = "";
  }
{% endblock %}

{% block document_ready %}
  $("#files").on("change", handleFileSelect);
  selDiv = $("#selectedFiles"); 
  //$("#form-edit-node").on("submit", handleForm);
  $("body").on("click", ".selFile", removeFile);

  attachedfiles();

  var select = document.getElementById("selectAllOptions");
  select.checked = false;

  {% if Status %}
  $("select[name='Status'] option[value='{{Status}}']").prop("selected", true);
  {% endif %}

  {% if Priority %}
  $("select[name='Status'] option[value='{{Priority}}']").prop("selected", true);
  {% endif %}

  {% if start_time %}
    var start_date  = document.getElementById("start_date");
    start_date.value = "{{start_time|date:'d/m/Y'}}";
  {% endif %}

  {% if end_time %}
    var end_date = document.getElementById("end_date");
    end_date.value = "{{end_time|date:'d/m/Y'}}";
  {% endif %}

  {% if Assignee %}
    var edit_Assignee = document.getElementById("customDropdown2");
    if ($("select[name='Assignee'] option[value='{{Assignee.0}}']").length) {
      {% for each in Assignee %}
        console.log("{{each}}");
        $("select[name='Assignee'] option[value='{{each}}']").prop("selected", true);
      {% endfor %}
    }

    else {
      console.log("else...{{Assignee}}");
      $("select[name='Assignee'] option[value='{{Assignee}}']").prop("selected", true);
    }
  {% endif %}

  // Start-date & End-date settings -------------------------------------------
    var start_date = $("#start_date");
    var end_date = $("#end_date");
    currentDate = new Date();
    var currentDay = currentDate.getDate();
    var currentMonth = currentDate.getMonth();
    var currentYear = currentDate.getFullYear();
  
    $(".date_month_day_year").datepicker({
      changeMonth: true,
      dateFormat: 'dd/mm/yy',
      minDate: '0',
      maxDate: '+2m',
      defaultDate: '0',

      onClose: function(dateText, inst) {
        $(this).val(dateText);
        
        var month_year = $(this).val();
        day = currentDay;
        month = currentMonth;
        year = currentYear;
        
        if ($(this).attr('id') == "start_date") {
          if (month_year) {
            month_year = month_year.split("/");
            day = parseInt(month_year[0]);
            month = parseInt(month_year[1]);
            year = parseInt(month_year[2]);
          }

          if (end_date.val() != '') {
            var testStartDate = start_date.datepicker('getDate');
            var testEndDate = end_date.datepicker('getDate');

            if (testStartDate > testEndDate) {
              end_date.datepicker('setDate', testStartDate);
            }

            else {
              $(this).val(day+"/"+month+"/"+year);
              $(this).datepicker('setDate', new Date(year, (month-1), day));
            }
          }

          else {
            end_date.val(day+"/"+month+"/"+year);
            $(this).datepicker('setDate', new Date(year, (month-1), day));
          }

          $("#end_date").datepicker('option', 'minDate', new Date(year, (month-1), day));
        }

        else if ($(this).attr('id') == "end_date") {
          if (month_year) {
            month_year = month_year.split("/");
            day = parseInt(month_year[0]);
            month = parseInt(month_year[1]);
            year = parseInt(month_year[2]);
          }

          if (start_date.val() != '') {
            var testStartDate = start_date.datepicker('getDate');
            var testEndDate = end_date.datepicker('getDate');

            if (testStartDate > testEndDate) {
              start_date.datepicker('setDate', testEndDate);
            }

            else {
              $(this).val(day+"/"+month+"/"+year);
              $(this).datepicker('setDate', new Date(year, (month-1), day));
            }
          }

          else {
            start_date.val(day+"/"+month+"/"+year);

            $(this).datepicker('setDate', new Date(year, (month-1), day));
          }
        }
      },

      beforeShow: function() {
        var month_year = $(this).val();
        day = currentDay;
        month = currentMonth;
        year = currentYear;

        if (month_year) {
          month_year = month_year.split("/");
          day = parseInt(month_year[0]);
          month = parseInt(month_year[1]);
          year = parseInt(month_year[2]);
        }

        $(this).datepicker('option', 'defaultDate', new Date(year, (month-1), day));
        $(this).datepicker('setDate', new Date(year, (month-1), day));
      },
    });
{% endblock %}
